<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Room</title>
        <style>
body {
    background-color: #333333;
}

canvas {
    background-color: #EEEEEE;
}
        </style>
    </head>

    <body>
        <canvas id="canvas" width=800 height=600></canvas>
        <script>
"use strict";

function intmod(i, n) {
    return ((Math.floor(i) % n) + n) % n;
}

var canvas = document.getElementById("canvas");
var context = canvas.getContext("2d");

var textures = {};
var assets_loading = 0;
var assets_ready = true;
function load(src, name) {
    var image = new Image();
    assets_loading++;
    assets_ready = false;
    image.onload = function() {
        var tempCanvas = document.createElement("canvas");
        tempCanvas.width = image.width;
        tempCanvas.height = image.height;
        var tempContext = tempCanvas.getContext("2d");
        tempContext.drawImage(image, 0, 0);
        var data = tempContext.getImageData(0, 0, image.width, image.height);
        textures[name] = data;
        //console.log(name, textures[name]);
        assets_loading--;
        assets_ready = assets_loading == 0;
    }
    image.onerror = function() {
        alert("Failed to load texture " + name + " from " + src);
    }
    image.src = src;
    return image;
}
load("floor.jpg", "floor");
//load("ceiling.png", "ceiling");
load("wall.jpg", "wall");
//load("chair.png", "chair");


var player_pos = {x: 1, y: 1};
var player_direction = 0;
var map = [
[1, 1, 1, 1, 1, 1],
[1, 0, 0, 0, 0, 1],
[1, 0, 0, 1, 0, 1],
[1, 0, 0, 0, 0, 1],
[1, 0, 0, 0, 0, 1],
[1, 1, 1, 1, 1, 1],
];

var FOV = 0.1;
var CELL_SIZE = 100;

var frame = context.createImageData(canvas.width, canvas.height);
var frameCount = 0;
function draw_texture(texture, sx, sy, frame, dx, dy) {
    sx = intmod(sx, texture.width);
    sy = intmod(sy, texture.height);
    var textureIndex = (sy * texture.width + sx) * 4;
    var frameIndex = (dy * frame.width + dx) * 4;
    frame.data[frameIndex + 0] = texture.data[textureIndex + 0];
    frame.data[frameIndex + 1] = texture.data[textureIndex + 1];
    frame.data[frameIndex + 2] = texture.data[textureIndex + 2];
    frame.data[frameIndex + 3] = texture.data[textureIndex + 3];
}
function render() {
    for (var i = 0; i < frame.data.length; i++) {
        frame.data[i] = 0;
    }
    var wall = textures["wall"];
    var floor = textures["floor"];
    for (var x = 0; x < frame.width; x++) {
        var angle = player_direction + (x / frame.width - 0.5) * FOV * Math.PI * 2;
        var world_x = player_pos.x;
        var world_y = player_pos.y;
        var step_x = Math.cos(angle) / 100;
        var step_y = Math.sin(angle) / 100;

        for (var y = 0; y < frame.height; y++) {
            draw_texture(floor, world_x * floor.width, world_y * floor.height, frame, x, y);
            world_x += step_x;
            world_y += step_y;
            step_x *= 1.01;
            step_y *= 1.01;

            var wx = Math.floor(world_x);
            var wy = Math.floor(world_y);
            if (map[wy][wx] != 0) {
                var bottom = frame.height - y;
                while (y++ < bottom) {
                }
                step_x *= -1;
                step_y *= -1;
            }
        }
    }
    context.putImageData(frame, 0, 0);
    context.fillText(frameCount++ + " " + player_pos.x + ", " + player_pos.y + " : " + player_direction, 15, 15);
}

var MOVEMENT_SPEED = 0.03;
var TURNING_SPEED = 0.02;
var STRAFING_FACTOR = 0.3;

var keys_pressed = {};
window.onkeydown = function(event) { keys_pressed[event.which] = true; }
window.onkeyup = function(event) { keys_pressed[event.which] = false; }
function move(angle, distance) {
    var dx = Math.cos(angle) * distance;
    if (map[Math.round(player_pos.y)][Math.round(player_pos.x + dx)] == 0) {
        player_pos.x += dx;
    }
    var dy = Math.sin(angle) * distance;
    if (map[Math.round(player_pos.y + dy)][Math.round(player_pos.x)] == 0) {
        player_pos.y += dy
    }
}
function update() {
    player_direction = player_direction % (Math.PI * 2);
    if (keys_pressed[37]) { // LEFT
        player_direction -= TURNING_SPEED;
    }
    if (keys_pressed[38] || keys_pressed[87]) { // UP or W
        move(player_direction, MOVEMENT_SPEED);
    }
    if (keys_pressed[65]) { // A
        move(player_direction - Math.PI / 2, MOVEMENT_SPEED * STRAFING_FACTOR);
    }
    if (keys_pressed[68]) { // D
        move(player_direction + Math.PI / 2, MOVEMENT_SPEED * STRAFING_FACTOR);
    }
    if (keys_pressed[39]) { // RIGHT
        player_direction += TURNING_SPEED;
    }
    if (keys_pressed[40] || keys_pressed[83]) { // DOWN or S
        move(player_direction, -MOVEMENT_SPEED);
    }
}

function update_frame() {
    if (assets_ready) {
        update();
        render();
    }
    window.requestAnimationFrame(update_frame);
}
window.requestAnimationFrame(update_frame);
canvas.requestPointerLock = canvas.requestPointerLock ||
                            canvas.mozRequestPointerLock ||
                            canvas.webkitRequestPointerLock;
var MOUSE_SENSITIVITY = 0.003;
canvas.onclick = function() {
    canvas.requestPointerLock();
    canvas.onmousemove = function(event) {
        var movementX = event.mozMovementX || event.webkitMovementX || event.movementX;
        if (movementX) {
            player_direction += movementX * MOUSE_SENSITIVITY;
        }
    }
}
        </script>
    </body>
</html>
