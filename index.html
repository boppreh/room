<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Room</title>
        <style>
body {
    background-color: #333333;
}

canvas {
    background-color: #EEEEEE;
}
        </style>
    </head>

    <body>
        <canvas id="canvas" width=800 height=600></canvas>
        <script>
"use strict";

function intmod(i, n) {
    return ((Math.floor(i) % n) + n) % n;
}

var canvas = document.getElementById("canvas");
var context = canvas.getContext("2d");

var textures = {};
var assets_loading = 0;
var assets_ready = true;
function load(src, name) {
    var image = new Image();
    assets_loading++;
    assets_ready = false;
    image.onload = function() {
        var tempCanvas = document.createElement("canvas");
        tempCanvas.width = image.width;
        tempCanvas.height = image.height;
        var tempContext = tempCanvas.getContext("2d");
        tempContext.drawImage(image, 0, 0);
        var data = tempContext.getImageData(0, 0, image.width, image.height);
        textures[name] = data;
        //console.log(name, textures[name]);
        assets_loading--;
        assets_ready = assets_loading == 0;
    }
    image.onerror = function() {
        alert("Failed to load texture " + name + " from " + src);
    }
    image.src = src;
    return image;
}
load("floor.jpg", "floor");
load("ceiling.png", "ceiling");
load("wall.jpg", "wall");
//load("chair.png", "chair");


var player_pos = {x: 1, y: 1};
var player_direction = 0;
var map = [
[1, 1, 1, 1, 1, 1],
[1, 0, 0, 0, 0, 1],
[1, 0, 0, 1, 0, 1],
[1, 0, 0, 0, 0, 1],
[1, 0, 0, 0, 0, 1],
[1, 1, 1, 1, 1, 1],
];

var FOV = 1;
var CELL_SIZE = 20;

var frame = context.createImageData(canvas.width, canvas.height);
var frameCount = 0;
function draw_texture(texture, sx, sy, frame, dx, dy) {
    sx = intmod(sx, texture.width);
    sy = intmod(sy, texture.height);
    var textureIndex = (sy * texture.width + sx) * 4;
    var frameIndex = (dy * frame.width + dx) * 4;
    frame.data[frameIndex + 0] = texture.data[textureIndex + 0];
    frame.data[frameIndex + 1] = texture.data[textureIndex + 1];
    frame.data[frameIndex + 2] = texture.data[textureIndex + 2];
    frame.data[frameIndex + 3] = texture.data[textureIndex + 3];
}
function render() {
    for (var i = 0; i < frame.data.length; i++) {
        frame.data[i] = 0;
    }
    var ceiling = textures["ceiling"];
    var wall = textures["wall"];
    var floor = textures["floor"];
    for (var x = 0; x < frame.width; x++) {
        var angle = player_direction + Math.atan2(x / frame.width - 0.5, FOV);
        var world_x = player_pos.x;
        var world_y = player_pos.y;
        var step_x = Math.cos(angle) / 100;
        var step_y = Math.sin(angle) / 100;

        var acceleration = 1.01;
        for (var y = 0; y < frame.height; y++) {
            draw_texture(ceiling, world_x * CELL_SIZE, world_y * CELL_SIZE, frame, x, y);
            draw_texture(floor, world_x * CELL_SIZE, world_y * CELL_SIZE, frame, x, frame.height - y);
            world_x += step_x;
            world_y += step_y;
            step_x *= acceleration;
            step_y *= acceleration;

            var wx = Math.round(world_x);
            var wy = Math.round(world_y);
            if (map[wy][wx] != 0) {
                break;
            }
        }
        //var distance = Math.sqrt(Math.pow(player_pos.x - world_x, 2) + Math.pow(player_pos.y - world_y, 2));
        var bottom = frame.height - y;
        var wall_y = 0;
        var wall_y_step = wall.height / (frame.height - 2 * y);
        while (y++ < bottom) {
            draw_texture(wall, (world_x - Math.floor(world_x)) * wall.width, wall_y, frame, x, y);
            wall_y += wall_y_step;
        }
    }
    context.putImageData(frame, 0, 0);
    context.fillText(frameCount++ + " " + player_pos.x + ", " + player_pos.y + " : " + player_direction, 15, 15);
}
function draw_minimap() {
    context.globalAlpha = 0.5;
    for (var y = 0; y < map.length; y++) {
        for (var x = 0; x < map[0].length; x++) {
            var cell = map[y][x];
            if (cell == 0) {
                continue;
            }
            context.fillStyle = "rgb(" + (cell * 20) + ", 0, 0)";
            context.fillRect(20 + x * 6, 20 + y * 6, 5, 5);
        }
    }
    context.fillStyle = "rgb(255, 0, 0)";
    context.strokeStyle = "rgb(255, 0, 0)";
    context.lineWidth = 2;
    context.fillRect(20 + player_pos.x * 6, 20 + player_pos.y * 6, 5, 5);
    context.beginPath();
    context.moveTo(20 + player_pos.x * 6 + 3, 20 + player_pos.y * 6 + 3);
    var dx = Math.cos(player_direction) * 6;
    var dy = Math.sin(player_direction) * 6;
    context.lineTo(20 + player_pos.x * 6 + 3 + dx, 20 + player_pos.y * 6 + 3 + dy);
    context.stroke();
}

var MOVEMENT_SPEED = 0.03;
var TURNING_SPEED = 0.02;
var STRAFING_FACTOR = 0.3;

var keys_pressed = {};
window.onkeydown = function(event) { keys_pressed[event.which] = true; }
window.onkeyup = function(event) { keys_pressed[event.which] = false; }
function move(angle, distance) {
    var dx = Math.cos(angle) * distance;
    if (map[Math.round(player_pos.y)][Math.round(player_pos.x + dx)] == 0) {
        player_pos.x += dx;
    }
    var dy = Math.sin(angle) * distance;
    if (map[Math.round(player_pos.y + dy)][Math.round(player_pos.x)] == 0) {
        player_pos.y += dy
    }
}
function update() {
    player_direction = player_direction % (Math.PI * 2);
    if (keys_pressed[37]) { // LEFT
        player_direction -= TURNING_SPEED;
    }
    if (keys_pressed[38] || keys_pressed[87]) { // UP or W
        move(player_direction, MOVEMENT_SPEED);
    }
    if (keys_pressed[65]) { // A
        move(player_direction - Math.PI / 2, MOVEMENT_SPEED * STRAFING_FACTOR);
    }
    if (keys_pressed[68]) { // D
        move(player_direction + Math.PI / 2, MOVEMENT_SPEED * STRAFING_FACTOR);
    }
    if (keys_pressed[39]) { // RIGHT
        player_direction += TURNING_SPEED;
    }
    if (keys_pressed[40] || keys_pressed[83]) { // DOWN or S
        move(player_direction, -MOVEMENT_SPEED);
    }
}

function update_frame() {
    if (assets_ready) {
        update();
        render();
        draw_minimap();
    }
    window.requestAnimationFrame(update_frame);
}
window.requestAnimationFrame(update_frame);
canvas.requestPointerLock = canvas.requestPointerLock ||
                            canvas.mozRequestPointerLock ||
                            canvas.webkitRequestPointerLock;
var MOUSE_SENSITIVITY = 0.003;
canvas.onclick = function() {
    canvas.requestPointerLock();
    canvas.onmousemove = function(event) {
        var movementX = event.mozMovementX || event.webkitMovementX || event.movementX;
        if (movementX) {
            player_direction += movementX * MOUSE_SENSITIVITY;
        }
    }
}
        </script>
    </body>
</html>
